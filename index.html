<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Totem de Lanches - Autoatendimento</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; display: flex; height: 100vh; background: #f4f4f4; }
        .menu { width: 65%; padding: 20px; display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; overflow-y: auto; }
        .item { background: white; border-radius: 10px; padding: 15px; text-align: center; box-shadow: 0 4px 6px rgba(0,0,0,0.1); cursor: pointer; transition: 0.2s; }
        .item:active { transform: scale(0.95); }
        .carrinho { width: 35%; background: #fff; border-left: 3px solid #009ee3; padding: 20px; display: flex; flex-direction: column; }
        .btn-pagar { background: #009ee3; color: white; border: none; padding: 15px; margin-top: 10px; border-radius: 5px; font-weight: bold; cursor: pointer; width: 100%; }
        .btn-pix { background: #00bfa5; }
        .btn-imprimir { background: #333; }
        #modal-pix { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 30px; border: 2px solid #000; z-index: 100; text-align: center; border-radius: 15px; width: 300px; }
        #qr-img { width: 250px; height: 250px; margin: 15px 0; border: 1px solid #eee; }
        .item-carrinho { display: flex; justify-content: space-between; padding: 5px 0; border-bottom: 1px solid #eee; }
    </style>
</head>
<body>

<div class="menu">
    <div class="item" onclick="add('X-Burguer', 20.00)">üçî X-Burguer<br>R$ 20,00</div>
    <div class="item" onclick="add('X-Salada', 22.00)">ü•ó X-Salada<br>R$ 22,00</div>
    <div class="item" onclick="add('X-Bacon', 25.00)">ü•ì X-Bacon<br>R$ 25,00</div>
    <div class="item" onclick="add('X-Tudo', 30.00)">üëë X-Tudo<br>R$ 30,00</div>
    <div class="item" onclick="add('Coca-Cola', 7.00)">ü•§ Coca-Cola<br>R$ 7,00</div>
    <div class="item" onclick="add('Suco Natural', 10.00)">üçä Suco<br>R$ 10,00</div>
    <div class="item" onclick="add('√Ågua', 4.00)">üíß √Ågua<br>R$ 4,00</div>
    <div class="item" onclick="add('Cerveja', 12.00)">üç∫ Cerveja<br>R$ 12,00</div>
</div>

<div class="carrinho">
    <h2>Meu Pedido</h2>
    <div id="lista-itens" style="flex-grow: 1; overflow-y: auto;">
        </div>
    <hr>
    <h3>Total: R$ <span id="total-valor">0.00</span></h3>
    <button class="btn-pagar" onclick="pagarCartao()">PAGAR COM CART√ÉO (MAQUININHA)</button>
    <button class="btn-pagar btn-pix" onclick="gerarPix()">PAGAR COM PIX (NA TELA)</button>
    <button class="btn-pagar btn-imprimir" onclick="imprimirPedido()">IMPRIMIR RECIBO TESTE</button>
</div>

<div id="modal-pix">
    <h3>Escaneie para Pagar</h3>
    <div id="qrcode-container">
        <img src="" id="qr-img" alt="QR Code Pix">
    </div>
    <p>Aguardando confirma√ß√£o do banco...</p>
    <button class="btn-pagar" onclick="confirmarPagamentoPix()">J√Å PAGUEI (CONFIRMAR)</button><br><br>
    <button onclick="fecharPix()">Cancelar</button>
</div>

<script>
    let total = 0;
    let pedido = [];

    // FUN√á√ÉO PARA ADICIONAR NO CARRINHO (CORRIGIDA)
    function add(nome, preco) {
        total += preco;
        pedido.push({nome: nome, preco: preco}); // Salva como objeto
        document.getElementById('total-valor').innerText = total.toFixed(2);
        
        const lista = document.getElementById('lista-itens');
        lista.innerHTML += `<div class="item-carrinho"><span>${nome}</span> <span>R$ ${preco.toFixed(2)}</span></div>`;
        lista.scrollTop = lista.scrollHeight; // Rola para baixo automaticamente
    }

    function pagarCartao() {
        if(total <= 0) return alert("Carrinho vazio!");
        const valor = total.toFixed(2);
        window.location.href = `mp-point://pay?amount=${valor}&description=PedidoLanche&editable_amount=false`;
    }

    // FUN√á√ÉO PIX COM TOKEN CORRIGIDO (CORRIGIDA)
    async function gerarPix() {
    if(total <= 0) return alert("Carrinho vazio!");
    
    document.getElementById('modal-pix').style.display = 'block';
    document.getElementById('qr-img').src = "https://www.wp-prevencao.com.br/assets/images/loading.gif";

    // GERA UMA CHAVE ALEAT√ìRIA PARA EVITAR O ERRO DE IDEMPOTENCY
    const idempotencyKey = Math.random().toString(36).substring(2, 15) + Math.random().toString(36).substring(2, 15);

    try {
        const response = await fetch("https://api.mercadopago.com/v1/payments", {
            method: "POST",
            headers: {
                "Authorization": "Bearer APP_USR-1998879028639759-021913-02c51f11e5b00f26dc6a0577a867ef53-273401276",
                "Content-Type": "application/json",
                "X-Idempotency-Key": idempotencyKey // <--- LINHA QUE RESOLVE O SEU ERRO
            },
            body: JSON.stringify({
                transaction_amount: parseFloat(total.toFixed(2)),
                description: "Pedido Totem Lanche",
                payment_method_id: "pix",
                payer: { 
                    email: "totem@email.com",
                    first_name: "Cliente",
                    last_name: "Totem"
                }
            })
        });

        const data = await response.json();
        
        if(data.point_of_interaction) {
            // MOSTRA O QR CODE NA TELA
            document.getElementById('qr-img').src = `data:image/png;base64,${data.point_of_interaction.transaction_data.qr_code_base64}`;
        } else {
            console.error("Detalhes do erro:", data);
            alert("Erro do Mercado Pago: " + (data.message || "Verifique os dados"));
            fecharPix();
        }
    } catch (error) {
        console.error("Erro na conex√£o:", error);
        alert("Erro de rede. Verifique sua internet.");
        fecharPix();
    }
}
    function fecharPix() { 
        document.getElementById('modal-pix').style.display = 'none'; 
    }

    function confirmarPagamentoPix() {
        alert("Pagamento Confirmado pelo Sistema!");
        fecharPix();
        imprimirPedido();
        
        // Limpar tudo ap√≥s o pagamento
        total = 0;
        pedido = [];
        document.getElementById('total-valor').innerText = "0.00";
        document.getElementById('lista-itens').innerHTML = "";
    }

    function imprimirPedido() {
        if (pedido.length === 0) return alert("N√£o h√° itens no pedido!");

        const janelaImpressao = window.open('', '', 'width=300,height=600');
        
        const listaItensHtml = pedido.map(item => `
            <div style="display: flex; justify-content: space-between;">
                <span>1x ${item.nome}</span>
                <span>R$ ${item.preco.toFixed(2)}</span>
            </div>
        `).join('');

        janelaImpressao.document.write(`
            <html>
            <body style="font-family: 'Courier New', monospace; width: 58mm; padding: 10px; font-size: 12px;">
                <div style="text-align: center;">
                    <strong>*** KINGIS BURGER ***</strong><br>
                    AUTOATENDIMENTO<br>
                    ${new Date().toLocaleString('pt-BR')}
                </div>
                <div style="border-top: 1px dashed #000; margin: 5px 0;"></div>
                ${listaItensHtml}
                <div style="border-top: 1px dashed #000; margin: 5px 0;"></div>
                <div style="text-align: center; font-size: 14px;">
                    <strong>TOTAL: R$ ${total.toFixed(2)}</strong>
                </div>
                <div style="border-top: 1px dashed #000; margin: 5px 0;"></div>
                <div style="text-align: center; font-size: 10px;">
                    Aguarde ser chamado pelo seu nome.<br>Obrigado!
                </div>
                <script>
                    window.onload = function() {
                        window.print();
                        setTimeout(() => { window.close(); }, 500);
                    }
                <\/script>
            </body>
            </html>
        `);
        janelaImpressao.document.close();
    }
</script>
</body>
</html>

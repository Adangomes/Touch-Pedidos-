<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Totem MyDi - Vendas</title>
    <style>
        :root {
            --primary: #ef4444;
            --secondary: #009ee3;
            --success: #10b981;
            --dark: #1e293b;
            --light: #f8fafc;
        }

        * { box-sizing: border-box; font-family: 'Segoe UI', system-ui, sans-serif; }
        body { margin: 0; background: #f1f5f9; display: flex; flex-direction: row; height: 100vh; overflow: hidden; }

        @media (max-width: 768px) {
            body { flex-direction: column; overflow-y: auto; }
            .menu-container { width: 100% !important; height: auto !important; }
            .carrinho-container { width: 100% !important; border-left: none !important; border-top: 2px solid #e2e8f0; }
        }

        .menu-container { width: 65%; display: flex; flex-direction: column; background: white; }
        .header { padding: 20px; background: var(--dark); color: white; font-weight: 800; font-size: 1.5rem; text-align: center; }
        
        .grid-produtos { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); 
            gap: 15px; padding: 20px; overflow-y: auto; 
        }

        .card-produto { 
            background: white; border: 1px solid #e2e8f0; border-radius: 15px; 
            overflow: hidden; cursor: pointer; transition: 0.2s;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
        }
        .card-produto:active { transform: scale(0.95); }
        .card-produto img { width: 100%; height: 140px; object-fit: cover; }
        .card-info { padding: 12px; }
        .card-nome { font-weight: bold; font-size: 1.1rem; display: block; }
        .card-preco { color: var(--success); font-weight: 800; font-size: 1.2rem; }

        .carrinho-container { width: 35%; background: var(--light); display: flex; flex-direction: column; border-left: 2px solid #e2e8f0; padding: 20px; }
        .lista-itens { flex-grow: 1; overflow-y: auto; }
        .item-row { background: white; padding: 10px; border-radius: 8px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; border: 1px solid #cbd5e1; }
        
        .input-group { margin-bottom: 15px; }
        input { width: 100%; padding: 12px; border: 1px solid #cbd5e1; border-radius: 8px; font-size: 1rem; margin-top: 5px; }
        .btn { border: none; padding: 16px; border-radius: 12px; color: white; font-weight: bold; font-size: 1rem; cursor: pointer; margin-top: 10px; transition: 0.2s; }
        .btn-cartao { background: var(--secondary); }
        .btn-pix { background: var(--success); }

        #modal-pix { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 100; align-items: center; justify-content: center; }
        .modal-box { background: white; padding: 30px; border-radius: 20px; text-align: center; max-width: 90%; }
        #qr-code { width: 200px; height: 200px; margin: 20px; object-fit: contain; }
    </style>
</head>
<body>

    <div id="modal-pix">
        <div class="modal-box">
            <h2>Pagamento PIX</h2>
            <img id="qr-code" src="https://www.wp-prevencao.com.br/assets/images/loading.gif" alt="QR">
            <p>Escaneie para pagar R$ <span id="valor-pix">0.00</span></p>
            <button class="btn btn-pix" onclick="finalizarPedido('PIX')">CONFIRMAR PAGAMENTO</button>
            <button onclick="fecharPix()" style="display:block; width:100%; border:none; background:none; color:gray; margin-top:10px; cursor:pointer">Cancelar</button>
        </div>
    </div>

    <div class="menu-container">
        <div class="header">MYDI DELIVERY - AUTOATENDIMENTO</div>
        <div class="grid-produtos" id="grid-produtos"></div>
    </div>

    <div class="carrinho-container">
        <h2 style="margin-top:0">Seu Pedido</h2>
        <div class="input-group">
            <input type="text" id="nome-cliente" placeholder="Seu Nome (Obrigatório)">
            <input type="text" id="obs-geral" placeholder="Alguma observação? (ex: sem cebola)">
        </div>

        <div id="lista-carrinho" class="lista-itens">
            <p style="text-align:center; color: #64748b;">O carrinho está vazio</p>
        </div>

        <div style="padding: 15px 0; border-top: 2px dashed #cbd5e1;">
            <div style="display:flex; justify-content:space-between; font-size:1.5rem; font-weight:800;">
                <span>Total:</span>
                <span>R$ <span id="total-valor">0.00</span></span>
            </div>
        </div>

        <button class="btn btn-cartao" onclick="pagarCartao()">PAGAR NA MAQUININHA (POINT)</button>
        <button class="btn btn-pix" onclick="gerarPix()">PAGAR COM PIX</button>
    </div>

<script>
    const produtos = [
        { id: 1, nome: 'X-Burguer', preco: 20.00, img: 'https://images.unsplash.com/photo-1568901346375-23c9450c58cd?w=400' },
        { id: 2, nome: 'X-Bacon', preco: 25.00, img: 'https://images.unsplash.com/photo-1553979459-d2229ba7433b?w=400' },
        { id: 3, nome: 'X-Salada', preco: 22.00, img: 'https://images.unsplash.com/photo-1550547660-d9450f859349?w=400' },
        { id: 4, nome: 'X-Tudo', preco: 30.00, img: 'https://images.unsplash.com/photo-1594212699903-ec8a3eca50f5?w=400' }
    ];

    let carrinho = [];
    let total = 0;

    if (!localStorage.getItem("proximoNumero")) localStorage.setItem("proximoNumero", "1");

    function renderProdutos() {
        const grid = document.getElementById('grid-produtos');
        grid.innerHTML = produtos.map(p => `
            <div class="card-produto" onclick="addAoCarrinho(${p.id})">
                <img src="${p.img}">
                <div class="card-info">
                    <span class="card-nome">${p.nome}</span>
                    <span class="card-preco">R$ ${p.preco.toFixed(2)}</span>
                </div>
            </div>
        `).join('');
    }

    function addAoCarrinho(id) {
        const p = produtos.find(item => item.id === id);
        const obs = document.getElementById('obs-geral').value;
        carrinho.push({ ...p, obs: obs });
        total += p.preco;
        document.getElementById('obs-geral').value = "";
        atualizarCarrinho();
    }

    function removerDoCarrinho(index) {
        total -= carrinho[index].preco;
        carrinho.splice(index, 1);
        atualizarCarrinho();
    }

    function atualizarCarrinho() {
        const lista = document.getElementById('lista-carrinho');
        if (carrinho.length === 0) {
            lista.innerHTML = '<p style="text-align:center; color: #64748b;">O carrinho está vazio</p>';
        } else {
            lista.innerHTML = carrinho.map((item, i) => `
                <div class="item-row">
                    <div><strong>${item.nome}</strong><br><small>${item.obs ? 'Obs: ' + item.obs : ''}</small></div>
                    <div style="display:flex; align-items:center; gap:10px;">
                        <span>R$ ${item.preco.toFixed(2)}</span>
                        <button onclick="removerDoCarrinho(${i})" style="border:none; background:none; color:red; font-weight:bold; cursor:pointer">X</button>
                    </div>
                </div>
            `).join('');
        }
        document.getElementById('total-valor').innerText = total.toFixed(2);
    }

    function pagarCartao() {
        if (!validarPedido()) return;
        const nPedido = localStorage.getItem("proximoNumero").padStart(2, '0');
        const valorFormatado = total.toFixed(2);
        const url = `mp-point://pay?amount=${valorFormatado}&description=Pedido-${nPedido}&editable_amount=false`;
        window.location.href = url;
        setTimeout(() => {
            if(confirm("O pagamento foi aprovado na maquininha?")) {
                finalizarPedido('CARTÃO');
            }
        }, 4000);
    }

    async function gerarPix() {
        if (!validarPedido()) return;
        
        // Abre o modal primeiro
        document.getElementById('modal-pix').style.display = 'flex';
        document.getElementById('valor-pix').innerText = total.toFixed(2);
        
        const token = "APP_USR-1998879028639759-021913-02c51f11e5b00f26dc6a0577a867ef53-273401276";
        
        try {
            const response = await fetch("https://api.mercadopago.com/v1/payments", {
                method: "POST",
                headers: { 
                    "Authorization": `Bearer ${token}`, 
                    "Content-Type": "application/json" 
                },
                body: JSON.stringify({
                    transaction_amount: parseFloat(total.toFixed(2)),
                    description: "Pedido Totem MyDi",
                    payment_method_id: "pix",
                    payer: { email: "cliente@email.com" }
                })
            });
            
            const data = await response.json();
            
            // Lógica direta para o QR Code
            if (data.point_of_interaction && data.point_of_interaction.transaction_data) {
                const qrBase64 = data.point_of_interaction.transaction_data.qr_code_base64;
                document.getElementById('qr-code').src = `data:image/png;base64,${qrBase64}`;
            } else {
                throw new Error("Dados do QR Code não encontrados");
            }

        } catch (e) {
            console.error(e);
            alert("Erro ao gerar Pix. Verifique a conexão ou o Token.");
            fecharPix();
        }
    }

    function finalizarPedido(metodo) {
        const num = localStorage.getItem("proximoNumero");
        const pedidoData = {
            numero: num.padStart(2, '0'),
            cliente: document.getElementById('nome-cliente').value,
            itens: [...carrinho],
            total: total,
            pagamento: metodo,
            hora: new Date().toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' })
        };

        let fila = JSON.parse(localStorage.getItem("fila_pedidos") || "[]");
        fila.push(pedidoData);
        localStorage.setItem("fila_pedidos", JSON.stringify(fila));

        localStorage.setItem("proximoNumero", parseInt(num) + 1);

        alert(`Pedido #${pedidoData.numero} ENVIADO!`);
        resetTotem();
    }

    function validarPedido() {
        if (total <= 0) { alert("Carrinho vazio!"); return false; }
        if (!document.getElementById('nome-cliente').value) { alert("Informe seu nome!"); return false; }
        return true;
    }

    function resetTotem() {
        carrinho = [];
        total = 0;
        document.getElementById('nome-cliente').value = "";
        atualizarCarrinho();
        fecharPix();
    }

    function fecharPix() { 
        document.getElementById('modal-pix').style.display = 'none'; 
        document.getElementById('qr-code').src = "https://www.wp-prevencao.com.br/assets/images/loading.gif";
    }

    renderProdutos();
</script>
</body>
</html>
